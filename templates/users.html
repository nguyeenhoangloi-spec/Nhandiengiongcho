{% extends "base_dashboard.html" %}

{% block title %}Qu·∫£n tr·ªã ng∆∞·ªùi d√πng{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/users.css') }}" />
{% endblock %}

{% block content %}
<div class="users-container">
  <div class="users-header">
    <div>
      <h1><i class="fa-solid fa-users"></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h1>
      <div class="users-subtitle">Ch·ªâ hi·ªÉn th·ªã v·ªõi t√†i kho·∫£n qu·∫£n tr·ªã.</div>
    </div>

    <div class="search-bar">
      <input id="usersSearch" type="text" placeholder="T√¨m theo username/email/h·ªç t√™n..." autocomplete="off" />
      <select id="roleFilter" aria-label="L·ªçc theo vai tr√≤">
        <option value="">T·∫•t c·∫£ vai tr√≤</option>
        <option value="admin">Admin</option>
        <option value="user">User</option>
      </select>
      <select id="statusFilter" aria-label="L·ªçc theo tr·∫°ng th√°i">
        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
        <option value="active">Ho·∫°t ƒë·ªông</option>
        <option value="locked">B·ªã kh√≥a</option>
      </select>
      <button type="button" class="users-filter-btn" id="clearFilters">X√≥a l·ªçc</button>
    </div>
  </div>

  <div class="users-stats" aria-label="Th·ªëng k√™">
    <div class="stat-box">
      <div class="stat-value" id="statTotal">0</div>
      <div class="stat-label">T·ªïng</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="statAdmins">0</div>
      <div class="stat-label">Admin</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="statActive">0</div>
      <div class="stat-label">Ho·∫°t ƒë·ªông</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="statLocked">0</div>
      <div class="stat-label">B·ªã kh√≥a</div>
    </div>
  </div>

  {% if users %}
  <div class="users-table-wrapper">
    <table class="users-table" id="usersTable">
      <thead>
        <tr>
          <th>Ng∆∞·ªùi d√πng</th>
          <th>H·ªç t√™n</th>
          <th>Vai tr√≤</th>
          <th>G√≥i</th>
          <th>Tr·∫°ng th√°i</th>
          <th>Ng√†y t·∫°o</th>
          <th>C·∫•p g√≥i</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr
          data-user-id="{{ u.id }}"
          data-role="{{ u.role or 'user' }}"
          data-active="{{ '1' if u.is_active else '0' }}"
        >
          <td>
            <div class="user-info">
              <div class="user-avatar">{{ (u.username or '?')[:1]|upper }}</div>
              <div class="user-details">
                <div class="user-name">{{ u.username }}</div>
                <div class="user-email">{{ u.email or '-' }}</div>
              </div>
            </div>
          </td>
          <td>{{ u.fullname or '-' }}</td>
          <td>
            <span class="role-badge {{ 'role-badge-admin' if u.role == 'admin' else 'role-badge-user' }}">
              {{ (u.role or 'user')|upper }}
            </span>
          </td>
          <td>
            <span class="plan-pill plan-{{ (u.plan or 'free')|lower }}">{{ (u.plan or 'free')|upper }}</span>
          </td>
          <td>
            <span class="status-badge {{ 'status-badge-active' if u.is_active else 'status-badge-inactive' }}">
              {{ 'Ho·∫°t ƒë·ªông' if u.is_active else 'B·ªã kh√≥a' }}
            </span>
          </td>
          <td class="created-at">{{ u.created_at }}</td>
          <td>
            <form method="POST" action="{{ url_for('users.set_user_plan') }}" class="plan-form">
              <input type="hidden" name="user_id" value="{{ u.id }}" />
              <select name="plan" class="plan-select" aria-label="Ch·ªçn g√≥i">
                <option value="free" {{ 'selected' if (u.plan or 'free') == 'free' else '' }}>FREE</option>
                <option value="basic" {{ 'selected' if (u.plan or '') == 'basic' else '' }}>BASIC</option>
                <option value="pro" {{ 'selected' if (u.plan or '') == 'pro' else '' }}>PRO</option>
                <option value="enterprise" {{ 'selected' if (u.plan or '') == 'enterprise' else '' }}>ENTERPRISE</option>
              </select>
              <button type="submit" class="plan-submit">C·∫≠p nh·∫≠t</button>
            </form>
          </td>
          <td>
            <div class="action-buttons">
              <button
                type="button"
                class="action-btn action-btn-view"
                data-action="view"
                title="Xem chi ti·∫øt"
                aria-label="Xem chi ti·∫øt"
              >
                üëÅÔ∏è
              </button>
              <button
                type="button"
                class="action-btn action-btn-lock"
                data-action="toggle"
                title="{{ 'Kh√≥a' if u.is_active else 'M·ªü kh√≥a' }}"
                aria-label="{{ 'Kh√≥a' if u.is_active else 'M·ªü kh√≥a' }}"
              >
                {{ 'üîí' if u.is_active else 'üîì' }}
              </button>
              <button
                type="button"
                class="action-btn action-btn-delete"
                data-action="delete"
                title="X√≥a"
                aria-label="X√≥a"
              >
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <i class="fa-solid fa-user-slash"></i>
    <h2>Ch∆∞a c√≥ ng∆∞·ªùi d√πng</h2>
    <p>Hi·ªán t·∫°i ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</p>
  </div>
  {% endif %}
</div>

<div class="modal-backdrop" id="userModalBackdrop" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
    <div class="modal-header">
      <div class="modal-title" id="userModalTitle">Th√¥ng tin ng∆∞·ªùi d√πng</div>
      <button type="button" class="modal-close" id="userModalClose" aria-label="ƒê√≥ng">‚úï</button>
    </div>
    <div class="modal-body" id="userModalBody">ƒêang t·∫£i...</div>
    <div class="modal-actions">
      <button type="button" class="users-filter-btn" id="userModalOk">ƒê√≥ng</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const searchEl = document.getElementById('usersSearch');
    const roleEl = document.getElementById('roleFilter');
    const statusEl = document.getElementById('statusFilter');
    const clearBtn = document.getElementById('clearFilters');
    const table = document.getElementById('usersTable');

    const statTotal = document.getElementById('statTotal');
    const statAdmins = document.getElementById('statAdmins');
    const statActive = document.getElementById('statActive');
    const statLocked = document.getElementById('statLocked');

    const modalBackdrop = document.getElementById('userModalBackdrop');
    const modalBody = document.getElementById('userModalBody');
    const modalClose = document.getElementById('userModalClose');
    const modalOk = document.getElementById('userModalOk');

    function openModal(html) {
      modalBody.innerHTML = html;
      modalBackdrop.hidden = false;
    }

    function closeModal() {
      modalBackdrop.hidden = true;
    }

    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });
    modalClose.addEventListener('click', closeModal);
    modalOk.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modalBackdrop.hidden) closeModal();
    });

    function getRows() {
      if (!table) return [];
      return Array.from(table.querySelectorAll('tbody tr'));
    }

    async function fetchJson(url, options) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);
      try {
        const res = await fetch(url, {
          credentials: 'same-origin',
          signal: controller.signal,
          ...(options || {}),
        });

        let data = null;
        try {
          data = await res.json();
        } catch (e) {
          data = null;
        }

        return { res, data, ok: res.ok && !!data };
      } finally {
        clearTimeout(timeoutId);
      }
    }

    function computeStats(rows) {
      const total = rows.length;
      const admins = rows.filter((r) => (r.dataset.role || '').toLowerCase() === 'admin').length;
      const active = rows.filter((r) => r.dataset.active === '1').length;
      const locked = rows.filter((r) => r.dataset.active === '0').length;
      statTotal.textContent = String(total);
      statAdmins.textContent = String(admins);
      statActive.textContent = String(active);
      statLocked.textContent = String(locked);
    }

    function applyFilters() {
      const q = (searchEl.value || '').trim().toLowerCase();
      const role = (roleEl.value || '').trim().toLowerCase();
      const status = (statusEl.value || '').trim().toLowerCase();

      let visible = 0;
      getRows().forEach((row) => {
        const hay = row.innerText.toLowerCase();
        const matchQ = !q || hay.includes(q);
        const matchRole = !role || (row.dataset.role || '').toLowerCase() === role;
        const isActive = row.dataset.active === '1';
        const matchStatus =
          !status ||
          (status === 'active' && isActive) ||
          (status === 'locked' && !isActive);

        const show = matchQ && matchRole && matchStatus;
        row.style.display = show ? '' : 'none';
        if (show) visible += 1;
      });

      // Stats: keep total based on all rows (not filtered)
      // Optional: could show visible count somewhere later.
      return visible;
    }

    if (searchEl) {
      ['input', 'change'].forEach((evt) => searchEl.addEventListener(evt, applyFilters));
    }
    if (roleEl) roleEl.addEventListener('change', applyFilters);
    if (statusEl) statusEl.addEventListener('change', applyFilters);
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        searchEl.value = '';
        roleEl.value = '';
        statusEl.value = '';
        applyFilters();
      });
    }

    // Actions
    if (table) {
      table.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const row = btn.closest('tr');
        if (!row) return;
        const userId = row.dataset.userId;
        const action = btn.dataset.action;
        const isActive = row.dataset.active === '1';

        try {
          if (action === 'view') {
            openModal('ƒêang t·∫£i...');
            let result;
            try {
              result = await fetchJson(`/users/detail/${userId}`);
            } catch (err) {
              console.error(err);
              openModal(
                `<div class="modal-error">Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß.</div>` +
                  `<div style="margin-top:12px;color:var(--text-secondary)">` +
                  `G·ª£i √Ω: ki·ªÉm tra terminal Flask c√≤n ch·∫°y kh√¥ng, r·ªìi reload trang.` +
                  `</div>`,
              );
              return;
            }

            const { res, data } = result;
            if (!res.ok || !data || !data.success) {
              const msg = data && data.error ? data.error : `HTTP ${res.status}`;
              openModal(
                `<div class="modal-error">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng (${msg}).</div>` +
                  `<div style="margin-top:12px;color:var(--text-secondary)">` +
                  `G·ª£i √Ω: xem log server ƒë·ªÉ bi·∫øt l·ªói chi ti·∫øt.` +
                  `</div>`,
              );
              return;
            }
            const u = data.user;
            const html = `
              <div class="user-detail-grid">
                <div><div class="kv-label">ID</div><div class="kv-value">${u.id}</div></div>
                <div><div class="kv-label">Username</div><div class="kv-value">${u.username}</div></div>
                <div><div class="kv-label">H·ªç t√™n</div><div class="kv-value">${u.fullname || '-'}</div></div>
                <div><div class="kv-label">Email</div><div class="kv-value">${u.email || '-'}</div></div>
                <div><div class="kv-label">Vai tr√≤</div><div class="kv-value">${(u.role || 'user').toUpperCase()}</div></div>
                <div><div class="kv-label">G√≥i</div><div class="kv-value">${(u.plan || 'free').toUpperCase()}</div></div>
                <div><div class="kv-label">Tr·∫°ng th√°i</div><div class="kv-value">${u.is_active ? 'Ho·∫°t ƒë·ªông' : 'B·ªã kh√≥a'}</div></div>
                <div><div class="kv-label">Ng√†y t·∫°o</div><div class="kv-value">${u.created_at || ''}</div></div>
              </div>
            `;
            openModal(html);
            return;
          }

          if (action === 'toggle') {
            const ok = confirm(isActive ? 'Kh√≥a ng∆∞·ªùi d√πng n√†y?' : 'M·ªü kh√≥a ng∆∞·ªùi d√πng n√†y?');
            if (!ok) return;
            const url = isActive ? `/users/lock/${userId}` : `/users/unlock/${userId}`;
            const res = await fetch(url, { method: 'POST' });
            const data = await res.json();
            if (!res.ok || !data || !data.success) {
              alert(data && data.error ? data.error : 'Thao t√°c th·∫•t b·∫°i.');
              return;
            }
            location.reload();
            return;
          }

          if (action === 'delete') {
            const ok = confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a user n√†y? H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c.');
            if (!ok) return;
            const res = await fetch(`/users/delete/${userId}`, { method: 'POST' });
            const data = await res.json();
            if (!res.ok || !data || !data.success) {
              alert(data && data.error ? data.error : 'X√≥a th·∫•t b·∫°i.');
              return;
            }
            row.remove();
            computeStats(getRows());
            applyFilters();
            return;
          }
        } catch (err) {
          console.error(err);
          openModal(
            `<div class="modal-error">C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω thao t√°c.</div>` +
              `<div style="margin-top:12px;color:var(--text-secondary)">` +
              `G·ª£i √Ω: reload trang v√† th·ª≠ l·∫°i.` +
              `</div>`,
          );
        }
      });
    }

    // Init
    computeStats(getRows());
    applyFilters();
  })();
</script>
{% endblock %}
