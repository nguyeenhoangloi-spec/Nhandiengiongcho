{% extends 'base_dashboard.html' %}
{% block title %}CÃ i Äáº·t{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/settings.css') }}" />
{% endblock %}

{% block content %}

<div class="page-header-pro">
  <div class="header-content">
    <h1><i class="icon">âš™ï¸</i> CÃ i Äáº·t</h1>
    <p>TÃ¹y chá»‰nh tráº£i nghiá»‡m sá»­ dá»¥ng cá»§a báº¡n</p>
  </div>
</div>

<div class="settings-container">
  <form method="POST" class="settings-form settings-grid">
    <aside class="settings-sidebar">
      <div class="sidebar-card">
        <div class="sidebar-title">Äiá»u hÆ°á»›ng</div>
        <nav class="sidebar-nav">
          <a href="#profile" class="sidebar-link">ğŸ‘¤ ThÃ´ng tin</a>
          <a href="#appearance" class="sidebar-link">ğŸ¨ Giao diá»‡n</a>
          <a href="#notifications" class="sidebar-link">ğŸ”” ThÃ´ng bÃ¡o</a>
          <a href="#privacy" class="sidebar-link">ğŸ”’ Quyá»n riÃªng tÆ°</a>
        </nav>
      </div>
    </aside>

    <div class="settings-main">
      <!-- Profile Section -->
      <section class="settings-section" id="profile">
        <div class="section-header">
          <h3><i class="icon">ğŸ‘¤</i> ThÃ´ng Tin CÃ¡ NhÃ¢n</h3>
        </div>
        <div class="section-content">
          <div class="form-group-pro">
            <label>TÃªn Ä‘Äƒng nháº­p</label>
            <input
              type="text"
              value="{{ session.get('username', '') }}"
              disabled
              class="input-pro"
            />
            <small class="input-hint">KhÃ´ng thá»ƒ thay Ä‘á»•i tÃªn Ä‘Äƒng nháº­p</small>
          </div>
        </div>
      </section>

      <!-- Appearance Section -->
      <section class="settings-section" id="appearance">
        <div class="section-header">
          <h3><i class="icon">ğŸ¨</i> Giao Diá»‡n</h3>
        </div>
        <div class="section-content">
          <div class="form-group-pro">
            <label>Theme</label>
            <div class="theme-cards">
              <label class="theme-card">
                <input type="radio" name="theme" value="light" {{ 'checked' if settings.theme == 'light' else '' }} />
                <span class="theme-card-body">
                  <span class="theme-icon">â˜€ï¸</span>
                  <span class="theme-title">SÃ¡ng</span>
                  <span class="theme-desc">Ná»n tráº¯ng, dá»… Ä‘á»c</span>
                </span>
              </label>
              <label class="theme-card">
                <input type="radio" name="theme" value="dark" {{ 'checked' if settings.theme == 'dark' else '' }} />
                <span class="theme-card-body">
                  <span class="theme-icon">ğŸŒ™</span>
                  <span class="theme-title">Tá»‘i</span>
                  <span class="theme-desc">Dá»‹u máº¯t buá»•i tá»‘i</span>
                </span>
              </label>
              <label class="theme-card">
                <input type="radio" name="theme" value="auto" {{ 'checked' if settings.theme == 'auto' else '' }} />
                <span class="theme-card-body">
                  <span class="theme-icon">ğŸ–¥ï¸</span>
                  <span class="theme-title">Tá»± Ä‘á»™ng</span>
                  <span class="theme-desc">Theo há»‡ Ä‘iá»u hÃ nh</span>
                </span>
              </label>
            </div>
            <small class="input-hint">Theme Ã¡p dá»¥ng cho khu vá»±c bÃªn trong sau khi Ä‘Äƒng nháº­p</small>
          </div>

          <div class="form-group-pro">
            <label for="language">NgÃ´n ngá»¯</label>
            <select name="language" id="language" class="select-pro">
              <option value="vi" {{ 'selected' if settings.language == 'vi' else '' }}>Tiáº¿ng Viá»‡t</option>
              <option value="en" {{ 'selected' if settings.language == 'en' else '' }}>English</option>
            </select>
            <small class="input-hint">NgÃ´n ngá»¯ hiá»ƒn thá»‹</small>
          </div>
        </div>
      </section>

      <!-- Notifications Section -->
      <section class="settings-section" id="notifications">
        <div class="section-header">
          <h3><i class="icon">ğŸ””</i> ThÃ´ng BÃ¡o</h3>
        </div>
        <div class="section-content">
          <div class="toggle-list">
            <div class="toggle-item">
              <div class="toggle-info">
                <label>ThÃ´ng bÃ¡o trong á»©ng dá»¥ng</label>
                <small>Hiá»ƒn thá»‹ thÃ´ng bÃ¡o khi cÃ³ hoáº¡t Ä‘á»™ng má»›i</small>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" name="notifications" {{ 'checked' if settings.notifications else '' }} />
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="toggle-item">
              <div class="toggle-info">
                <label>ThÃ´ng bÃ¡o qua Email</label>
                <small>Nháº­n email vá» cÃ¡c cáº­p nháº­t quan trá»ng</small>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" name="email_notifications" {{ 'checked' if settings.email_notifications else '' }} />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>
      </section>

      <!-- Privacy Section -->
      <section class="settings-section" id="privacy">
        <div class="section-header">
          <h3><i class="icon">ğŸ”’</i> Báº£o Máº­t & Quyá»n RiÃªng TÆ°</h3>
        </div>
        <div class="section-content">
          <div class="info-box info-warning">
            <i class="icon">âš ï¸</i>
            <div>
              <strong>LÆ°u Ã½ vá» dá»¯ liá»‡u</strong>
              <p>
                áº¢nh vÃ  káº¿t quáº£ nháº­n diá»‡n cá»§a báº¡n Ä‘Æ°á»£c lÆ°u trá»¯ Ä‘á»ƒ cáº£i thiá»‡n tráº£i
                nghiá»‡m. Báº¡n cÃ³ thá»ƒ xÃ³a lá»‹ch sá»­ báº¥t cá»© lÃºc nÃ o.
              </p>
            </div>
          </div>

          <div class="action-buttons-group">
            <a href="{{ url_for('history.history') }}" class="btn-outline">
              <i class="icon">ğŸ“š</i> Xem Lá»‹ch Sá»­
            </a>
            <button
              type="submit"
              class="btn-danger"
              formaction="{{ url_for('settings.clear_history') }}"
              formmethod="POST"
              onclick="return confirmClearHistory(event)"
            >
              <i class="icon">ğŸ—‘ï¸</i> XÃ³a Lá»‹ch Sá»­
            </button>
          </div>
        </div>
      </section>

      <!-- Save Button -->
      <div class="settings-actions settings-actions-sticky">
        <button type="submit" class="btn-gradient-large">
          <i class="icon">ğŸ’¾</i> LÆ°u Thay Äá»•i
        </button>
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn-outline-large">
          <i class="icon">âŒ</i> Há»§y
        </a>
      </div>
    </div>
  </form>
</div>

<script>

  // Khi chá»n theme: chá»‰ Ä‘á»•i giao diá»‡n táº¡m thá»i (data-theme), KHÃ”NG lÆ°u localStorage
  let pendingTheme = (document.querySelector('input[name="theme"]:checked') || {}).value || 'light';

  function resolveTheme(theme) {
    if (theme !== 'auto') return theme;
    try {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      return prefersDark ? 'dark' : 'light';
    } catch (e) {
      return 'light';
    }
  }

  function applyThemePreview(theme) {
    document.documentElement.setAttribute('data-theme', resolveTheme(theme));
  }

  // Apply initial preview (in case current selection is auto)
  applyThemePreview(pendingTheme);

  document.querySelectorAll('input[name="theme"]').forEach((el) => {
    el.addEventListener('change', function () {
      pendingTheme = this.value;
      applyThemePreview(pendingTheme);
    });
  });

  // Khi submit form (báº¥m LÆ°u): má»›i lÆ°u localStorage vÃ  giá»¯ theme Ä‘Ã³ cho láº§n sau
  document.querySelector('.settings-form').addEventListener('submit', function(e) {
    if (pendingTheme) {
      try {
        localStorage.setItem('theme', pendingTheme);
      } catch(e) {}
    }
  });

  function confirmClearHistory(e) {
    const ok = confirm(
      "Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a toÃ n bá»™ lá»‹ch sá»­ nháº­n diá»‡n? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!",
    );
    if (!ok) {
      if (e) e.preventDefault();
      return false;
    }
    return true;
  }
</script>

{% endblock %}
